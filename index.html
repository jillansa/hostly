<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pizzería</title>
    
    <!-- Tailwind CSS para un diseño moderno y adaptable -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js para los mapas de geolocalización -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Estilos personalizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: 400px; border-radius: 0.5rem; }
        .leaflet-container { background: #f9f9f9; }
        .leaflet-marker-icon {
            text-align: center;
            font-weight: bold;
        }
        .driver-marker .marker-label {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 2px 5px;
            border: 1px solid #ccc;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor principal de la aplicación -->
    <div id="app-container" class="min-h-screen">

        <!-- VISTA DE LOGIN (Inicial) -->
        <div id="login-view" class="flex items-center justify-center min-h-screen bg-gray-900">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <div class="text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-auto text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 18.25a7.25 7.25 0 100-14.5 7.25 7.25 0 000 14.5zM11 12.75a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 11.25v3M11 8.25h.007" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.283 11.25h17.433" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.002 3.283c2.982.176 5.5 2.69 5.5 5.717v.5a.75.75 0 01-1.5 0v-.5c0-2.21-1.79-4-4-4s-4 1.79-4 4v.5a.75.75 0 01-1.5 0v-.5c0-3.027 2.518-5.541 5.5-5.717z" />
                    </svg>
                    <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Pizzeria Manager</h2>
                    <p class="mt-2 text-sm text-gray-600">Inicia sesión para continuar</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="email" class="sr-only">Email</label>
                        <input id="email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Email">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Contraseña</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Contraseña">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Entrar
                    </button>
                </form>
                <p id="login-error" class="text-sm text-center text-red-500"></p>
            </div>
        </div>

        <!-- VISTA PRINCIPAL (Después del login) -->
        <div id="main-view" class="hidden">
            <header class="bg-gray-800 text-white shadow-lg">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <h1 class="text-xl font-bold">Pizzeria Manager</h1>
                    <div>
                        <span id="user-email" class="mr-4 text-sm"></span>
                        <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm">Cerrar Sesión</button>
                    </div>
                </div>
            </header>
            
            <main class="container mx-auto p-4 md:p-6">
                <!-- VISTA DE EMPLEADO -->
                <div id="employee-view" class="hidden space-y-6">
                    <!-- Sección de Fichaje -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Control Horario</h2>
                        <div id="time-clock-section" class="text-center">
                            <p class="mb-4">Tu estado actual: <span id="clock-status" class="font-semibold">Desconocido</span></p>
                            <button id="clock-in-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg">Fichar Entrada</button>
                            <button id="clock-out-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg text-lg hidden">Fichar Salida</button>
                        </div>
                    </div>
                    
                    <!-- Sección de Pedidos Asignados (solo para repartidores) -->
                    <div id="driver-orders-section" class="hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Mis Pedidos Asignados</h2>
                        <div id="assigned-orders-list" class="space-y-4">
                            <!-- Los pedidos se cargarán aquí dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- VISTA DE ADMINISTRADOR -->
                <div id="admin-view" class="hidden">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-500 text-white p-4 rounded-lg shadow-md">
                            <h3 class="font-bold">Empleados Activos</h3>
                            <p id="active-employees-stat" class="text-2xl">0</p>
                        </div>
                        <div class="bg-green-500 text-white p-4 rounded-lg shadow-md">
                            <h3 class="font-bold">Pedidos Pendientes</h3>
                            <p id="pending-orders-stat" class="text-2xl">0</p>
                        </div>
                        <div class="bg-purple-500 text-white p-4 rounded-lg shadow-md">
                            <h3 class="font-bold">Repartidores en Ruta</h3>
                            <p id="drivers-on-route-stat" class="text-2xl">0</p>
                        </div>
                    </div>
                    
                    <!-- Pestañas de Navegación del Admin -->
                    <div class="mb-4 border-b border-gray-200">
                        <nav id="admin-tabs" class="flex space-x-4" aria-label="Tabs">
                            <button data-tab="map" class="admin-tab text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md">Mapa Repartidores</button>
                            <button data-tab="orders" class="admin-tab text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md">Gestión Pedidos</button>
                            <button data-tab="staff" class="admin-tab text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md">Gestión Personal</button>
                            <button data-tab="time-entries" class="admin-tab text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md">Registro Fichajes</button>
                        </nav>
                    </div>

                    <div id="admin-content" class="bg-white p-6 rounded-lg shadow-md">
                        <!-- Contenido de Mapa -->
                        <div id="map-content" class="admin-tab-content">
                            <h2 class="text-2xl font-bold mb-4">Ubicación de Repartidores en Tiempo Real</h2>
                            <div id="map"></div>
                        </div>

                        <!-- Contenido de Pedidos -->
                        <div id="orders-content" class="admin-tab-content hidden">
                            <h2 class="text-2xl font-bold mb-4">Gestión de Pedidos</h2>
                            <button id="show-add-order-form" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md mb-4">Crear Nuevo Pedido</button>
                            
                            <!-- Formulario para añadir pedido -->
                            <form id="add-order-form" class="hidden p-4 mb-4 bg-gray-50 border rounded-lg space-y-3">
                                <h3 class="text-lg font-semibold">Nuevo Pedido</h3>
                                <input id="customer-name" type="text" placeholder="Nombre del Cliente" class="w-full p-2 border rounded-md">
                                <input id="customer-address" type="text" placeholder="Dirección de Entrega" class="w-full p-2 border rounded-md">
                                <textarea id="order-items" placeholder="Artículos del pedido (ej: Pizza Barbacoa, 2x Coca-Cola)" class="w-full p-2 border rounded-md"></textarea>
                                <div class="flex gap-2">
                                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">Guardar Pedido</button>
                                    <button type="button" id="cancel-add-order" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Cancelar</button>
                                </div>
                            </form>

                            <div id="admin-orders-list" class="space-y-4"></div>
                        </div>

                        <!-- Contenido de Personal -->
                        <div id="staff-content" class="admin-tab-content hidden">
                             <h2 class="text-2xl font-bold mb-4">Gestión de Personal</h2>
                             <button id="show-add-staff-form" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md mb-4">Añadir Empleado</button>
                             
                             <!-- Formulario para añadir empleado -->
                             <form id="add-staff-form" class="hidden p-4 mb-4 bg-gray-50 border rounded-lg space-y-3">
                                 <h3 class="text-lg font-semibold">Nuevo Empleado</h3>
                                 <input id="staff-name" type="text" placeholder="Nombre Completo" class="w-full p-2 border rounded-md">
                                 <input id="staff-email" type="email" placeholder="Email (para login)" class="w-full p-2 border rounded-md">
                                 <input id="staff-password" type="password" placeholder="Contraseña" class="w-full p-2 border rounded-md">
                                 <select id="staff-role" class="w-full p-2 border rounded-md">
                                     <option value="empleado">Empleado</option>
                                     <option value="repartidor">Repartidor</option>
                                     <option value="cocinero">Cocinero</option>
                                     <option value="admin">Administrador</option>
                                 </select>
                                 <div class="flex gap-2">
                                     <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">Guardar Empleado</button>
                                     <button type="button" id="cancel-add-staff" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Cancelar</button>
                                 </div>
                                 <p id="add-staff-error" class="text-sm text-red-500"></p>
                             </form>
                             
                             <div id="staff-list" class="space-y-2"></div>
                        </div>
                        
                        <!-- Contenido de Registro de Fichajes -->
                        <div id="time-entries-content" class="admin-tab-content hidden">
                            <h2 class="text-2xl font-bold mb-4">Historial de Fichajes</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-800 text-white">
                                        <tr>
                                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Empleado</th>
                                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Entrada</th>
                                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Salida</th>
                                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Duración</th>
                                        </tr>
                                    </thead>
                                    <tbody id="time-entries-list" class="text-gray-700">
                                        <!-- Las entradas se cargarán aquí -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importa las funciones que necesitas de los SDKs de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc,
            addDoc,
            collection, 
            onSnapshot,
            query,
            where,
            Timestamp,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN Y VARIABLES GLOBALES ---

        // La configuración de Firebase se inyectará aquí.
        // En un entorno real, estos valores vendrían de tu consola de Firebase.
        //const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBZRE3MDgZrrCFBN-NIQm3FaaCkH8WSc-E",
            authDomain: "tavolatpv.firebaseapp.com",
            projectId: "tavolatpv",
            storageBucket: "tavolatpv.firebasestorage.app",
            messagingSenderId: "1094358998769",
            appId: "1:1094358998769:web:007696239b19cd87acd350",
            measurementId: "G-EHHK43P9Q0"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pizzeria-app-default';

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserProfile = null;
        let map = null;
        let driverMarkers = {};
        let locationWatcherId = null;

        // --- VISTAS Y ELEMENTOS DEL DOM ---
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');
        const employeeView = document.getElementById('employee-view');
        const adminView = document.getElementById('admin-view');
        
        // --- LÓGICA DE AUTENTICACIÓN ---

        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged");
            if (user) {
                console.log("onAuthStateChanged + user");
                
                // Usuario ha iniciado sesión
                currentUser = user;

                for (let clave in user) {
                    console.log(clave + ": " + user[clave]);
                }
                console.log("onAuthStateChanged - fetchUserProfile");
                console.log("onAuthStateChanged - fetchUserProfile - user.uid=" + user.uid);
                await fetchUserProfile(user.uid);
                console.log("onAuthStateChanged + fetchUserProfile");
                
                document.getElementById('user-email').textContent = user.email;
                loginView.classList.add('hidden');
                mainView.classList.remove('hidden');
                console.log("XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX");
                for (let clave in currentUserProfile) {
                    console.log("currentUserProfile:" + clave + ": " + currentUserProfile[clave]);
                }

                if (currentUserProfile && currentUserProfile.role === 'admin') {
                    console.log("onAuthStateChanged + setupAdminView");
                    setupAdminView();
                } else {
                    console.log("onAuthStateChanged + setupEmployeeView");
                    setupEmployeeView();
                }
            } else {
                // Usuario no ha iniciado sesión
                currentUser = null;
                currentUserProfile = null;
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
                if (locationWatcherId) {
                    navigator.geolocation.clearWatch(locationWatcherId);
                    locationWatcherId = null;
                }
            }
        });

        async function fetchUserProfile(uid) {
            
            console.log("fetchUserProfile: " + `artifacts/${appId}/public/data/users/` + uid);
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
            console.log("fetchUserProfile: userDocRef=" + userDocRef);
            
            for (let clave in userDocRef) {
                console.log(clave + ": " + userDocRef[clave]);
            }

            const userDocSnap = await getDoc(userDocRef);
            console.log("fetchUserProfile GUAY");
            console.log("fetchUserProfile GUAY");
            console.log("");
            console.log("");

            for (let clave in userDocSnap) {
                console.log("userDocSnap." + clave + ": " + userDocSnap[clave]);
            }

            
            if (userDocSnap.exists()) {
                console.error("HAy currentUserProfile:", uid);
                currentUserProfile = { id: userDocSnap.id, ...userDocSnap.data() };
            } else {
                console.error("No user profile found for UID:", uid);
                // Podríamos crear un perfil por defecto o cerrar sesión
            }
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            const loginError = document.getElementById('login-error');
            console.error("TRAza-1");
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Login error:", error);
                    console.error("TRAza");
                    loginError.textContent = "Email o contraseña incorrectos.";
                });
                console.error("TRAza-3");
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        // --- LÓGICA DE VISTAS (ADMIN/EMPLEADO) ---

        function setupAdminView() {
            console.log("setupAdminView");
            adminView.classList.remove('hidden');
            employeeView.classList.add('hidden');
            
            initializeMap();
            listenToOrders();
            listenToStaff();
            listenToTimeEntries();
            listenToStats();
            
            // Pestañas del admin
            const tabs = document.querySelectorAll('.admin-tab');
            const tabContents = document.querySelectorAll('.admin-tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('border-b-2', 'border-red-500', 'text-red-600'));
                    tab.classList.add('border-b-2', 'border-red-500', 'text-red-600');
                    
                    tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${tab.dataset.tab}-content`).classList.remove('hidden');

                    if(tab.dataset.tab === 'map') {
                        setTimeout(() => map.invalidateSize(), 100); // Refrescar mapa al mostrar
                    }
                });
            });
            // Activar la primera pestaña por defecto
            tabs[0].click();
        }

        function setupEmployeeView() {
            adminView.classList.add('hidden');
            employeeView.classList.remove('hidden');
            
            setupTimeClock();
            console.log("setupEmployeeView")

            if (currentUserProfile.role === 'repartidor') {
                document.getElementById('driver-orders-section').classList.remove('hidden');
                listenToAssignedOrders();
            }
        }
        
        // --- LÓGICA DE FICHAJE (EMPLEADO) ---

        function setupTimeClock() {
            const clockStatus = document.getElementById('clock-status');
            const clockInBtn = document.getElementById('clock-in-button');
            const clockOutBtn = document.getElementById('clock-out-button');

            // Actualizar UI basado en el perfil del usuario
            function updateClockUI(isClockedIn) {
                if (isClockedIn) {
                    clockStatus.textContent = 'TRABAJANDO';
                    clockStatus.className = 'font-semibold text-green-600';
                    clockInBtn.classList.add('hidden');
                    clockOutBtn.classList.remove('hidden');
                } else {
                    clockStatus.textContent = 'FUERA DE SERVICIO';
                    clockStatus.className = 'font-semibold text-red-600';
                    clockInBtn.classList.remove('hidden');
                    clockOutBtn.classList.add('hidden');
                }
            }
            
            updateClockUI(currentUserProfile.isClockedIn);
            
            // Escuchar cambios en el perfil del propio usuario
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    currentUserProfile.isClockedIn = userData.isClockedIn;
                    updateClockUI(userData.isClockedIn);
                    
                    // Gestionar seguimiento de ubicación para repartidores
                    if (currentUserProfile.role === 'repartidor') {
                        if (userData.isClockedIn && !locationWatcherId) {
                            startLocationTracking();
                        } else if (!userData.isClockedIn && locationWatcherId) {
                            stopLocationTracking();
                        }
                    }
                }
            });

            clockInBtn.addEventListener('click', async () => {
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid);
                const timeEntryRef = collection(db, `artifacts/${appId}/public/data/time_entries`);
                
                try {
                    const newEntry = await addDoc(timeEntryRef, {
                        userId: currentUser.uid,
                        userName: currentUserProfile.name,
                        clockInTime: serverTimestamp(),
                        clockOutTime: null,
                    });
                    await updateDoc(userRef, {
                        isClockedIn: true,
                        current_time_entry_id: newEntry.id
                    });
                } catch (e) { console.error("Error clocking in: ", e); }
            });

            clockOutBtn.addEventListener('click', async () => {
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid);
                if (currentUserProfile.current_time_entry_id) {
                    const timeEntryRef = doc(db, `artifacts/${appId}/public/data/time_entries`, currentUserProfile.current_time_entry_id);
                    try {
                        await updateDoc(timeEntryRef, { clockOutTime: serverTimestamp() });
                        await updateDoc(userRef, { isClockedIn: false, current_time_entry_id: null });
                    } catch (e) { console.error("Error clocking out: ", e); }
                }
            });
        }

        // --- LÓGICA DE GEOLOCALIZACIÓN (REPARTIDOR) ---

        function startLocationTracking() {
            if (!('geolocation' in navigator)) {
                console.error("Geolocation is not supported by your browser.");
                return;
            }
            locationWatcherId = navigator.geolocation.watchPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid);
                    try {
                        await updateDoc(userRef, {
                            location: new Timestamp(Math.floor(Date.now() / 1000), 0), // Firestore GeoPoint no es soportado directamente en web SDK v9+, usamos un objeto
                            location_coords: { lat: latitude, lng: longitude },
                            lastLocationUpdate: serverTimestamp()
                        });
                    } catch(e) { console.error("Error updating location:", e); }
                },
                (error) => {
                    console.error("Error getting location:", error);
                },
                { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
            );
        }

        function stopLocationTracking() {
            if (locationWatcherId) {
                navigator.geolocation.clearWatch(locationWatcherId);
                locationWatcherId = null;
                console.log("Location tracking stopped.");
            }
        }
        
        // --- LÓGICA DE ADMINISTRADOR ---
        
        function initializeMap() {
            if (map) return;
            map = L.map('map').setView([37.9922, -1.1307], 13); // Centrado en Murcia
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Escuchar a los repartidores activos
            const q = query(collection(db, `artifacts/${appId}/public/data/users`), where("role", "==", "repartidor"), where("isClockedIn", "==", true));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const driver = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === "added" || change.type === "modified") {
                        if (driver.location_coords) {
                            updateDriverMarker(driver);
                        }
                    }
                    if (change.type === "removed") {
                        removeDriverMarker(driver.id);
                    }
                });
            });
        }

        function updateDriverMarker(driver) {
            const { lat, lng } = driver.location_coords;
            const markerContent = L.divIcon({
                className: 'driver-marker',
                html: `<div class="marker-label">${driver.name}</div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-red-600"><path d="M3.375 4.5C2.339 4.5 1.5 5.34 1.5 6.375V13.5h12V6.375c0-1.036-.84-1.875-1.875-1.875h-8.25zM13.5 15h-12v2.625c0 1.035.84 1.875 1.875 1.875h.375a3 3 0 116 0h3a.75.75 0 00.75-.75V15z" /><path d="M16.5 4.5c0-1.036.84-1.875 1.875-1.875h1.5C20.91 2.625 22.5 4.215 22.5 6v12a.75.75 0 01-1.5 0v-6.75a.75.75 0 00-.75-.75h-3.75a.75.75 0 00-.75.75V18a.75.75 0 01-1.5 0V6c0-1.785 1.59-3.375 3.375-3.375z" /></svg>`,
                iconSize: [32, 42],
                iconAnchor: [16, 42]
            });

            if (driverMarkers[driver.id]) {
                driverMarkers[driver.id].setLatLng([lat, lng]);
            } else {
                driverMarkers[driver.id] = L.marker([lat, lng], { icon: markerContent }).addTo(map);
            }
        }

        function removeDriverMarker(driverId) {
            if (driverMarkers[driverId]) {
                map.removeLayer(driverMarkers[driverId]);
                delete driverMarkers[driverId];
            }
        }
        
        // --- Gestión de Pedidos (Admin) ---
        document.getElementById('show-add-order-form').addEventListener('click', () => {
            document.getElementById('add-order-form').classList.remove('hidden');
        });
        document.getElementById('cancel-add-order').addEventListener('click', () => {
            document.getElementById('add-order-form').classList.add('hidden');
            document.getElementById('add-order-form').reset();
        });
        document.getElementById('add-order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerName = document.getElementById('customer-name').value;
            const address = document.getElementById('customer-address').value;
            const items = document.getElementById('order-items').value.split(',').map(item => item.trim());

            if (!customerName || !address || items.length === 0) {
                alert("Por favor, rellena todos los campos.");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), {
                    customerName,
                    address,
                    items,
                    status: 'pending', // pending, preparing, out_for_delivery, delivered
                    assignedDriverId: null,
                    assignedDriverName: null,
                    createdAt: serverTimestamp()
                });
                document.getElementById('add-order-form').classList.add('hidden');
                document.getElementById('add-order-form').reset();
            } catch (error) {
                console.error("Error adding order: ", error);
            }
        });

        function listenToOrders() {
            const q = query(collection(db, `artifacts/${appId}/public/data/orders`));
            onSnapshot(q, (snapshot) => {
                const orderList = document.getElementById('admin-orders-list');
                orderList.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const order = { id: docSnap.id, ...docSnap.data() };
                    orderList.appendChild(createOrderCard(order));
                });
            });
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg bg-gray-50';
            
            const statusColors = {
                pending: 'bg-yellow-200 text-yellow-800',
                preparing: 'bg-blue-200 text-blue-800',
                out_for_delivery: 'bg-indigo-200 text-indigo-800',
                delivered: 'bg-green-200 text-green-800',
            };
            const statusText = {
                pending: 'Pendiente',
                preparing: 'En preparación',
                out_for_delivery: 'En reparto',
                delivered: 'Entregado',
            };

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg">${order.customerName}</p>
                        <p class="text-sm text-gray-600">${order.address}</p>
                        <p class="text-sm mt-2"><strong>Pedido:</strong> ${order.items.join(', ')}</p>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColors[order.status] || ''}">${statusText[order.status] || order.status}</span>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <p class="text-sm"><strong>Repartidor:</strong> ${order.assignedDriverName || 'Sin asignar'}</p>
                    <div class="mt-2 flex gap-2 flex-wrap items-center">
                        ${order.status !== 'delivered' ? `
                        <select id="driver-select-${order.id}" class="p-1 border rounded-md text-sm">
                            <option value="">Asignar repartidor...</option>
                        </select>
                        <button data-order-id="${order.id}" class="assign-driver-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Asignar</button>
                        <button data-order-id="${order.id}" class="mark-delivered-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Marcar Entregado</button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Llenar el select de repartidores
            if (order.status !== 'delivered') {
                const select = card.querySelector(`#driver-select-${order.id}`);
                const q = query(collection(db, `artifacts/${appId}/public/data/users`), where("role", "==", "repartidor"), where("isClockedIn", "==", true));
                getDocs(q).then(snapshot => {
                    snapshot.forEach(doc => {
                        const driver = { id: doc.id, ...doc.data() };
                        const option = document.createElement('option');
                        option.value = driver.id;
                        option.textContent = driver.name;
                        option.dataset.name = driver.name;
                        if (order.assignedDriverId === driver.id) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                });
            }

            return card;
        }

        document.getElementById('admin-orders-list').addEventListener('click', async (e) => {
            if (e.target.classList.contains('assign-driver-btn')) {
                const orderId = e.target.dataset.orderId;
                const select = document.getElementById(`driver-select-${orderId}`);
                const driverId = select.value;
                const driverName = select.options[select.selectedIndex].dataset.name;
                if (driverId) {
                    const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
                    await updateDoc(orderRef, {
                        assignedDriverId: driverId,
                        assignedDriverName: driverName,
                        status: 'out_for_delivery'
                    });
                }
            }
            if (e.target.classList.contains('mark-delivered-btn')) {
                const orderId = e.target.dataset.orderId;
                const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
                await updateDoc(orderRef, { status: 'delivered' });
            }
        });
        
        // --- Gestión de Personal (Admin) ---
        document.getElementById('show-add-staff-form').addEventListener('click', () => {
            document.getElementById('add-staff-form').classList.remove('hidden');
        });
        document.getElementById('cancel-add-staff').addEventListener('click', () => {
            document.getElementById('add-staff-form').classList.add('hidden');
            document.getElementById('add-staff-form').reset();
        });
        document.getElementById('add-staff-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('staff-name').value;
            const email = document.getElementById('staff-email').value;
            const password = document.getElementById('staff-password').value;
            const role = document.getElementById('staff-role').value;
            const errorP = document.getElementById('add-staff-error');
            errorP.textContent = '';

            if (!name || !email || !password || !role) {
                errorP.textContent = "Todos los campos son obligatorios.";
                return;
            }

            try {
                // Crear usuario en Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Crear perfil de usuario en Firestore
                await setDoc(doc(db, `artifacts/${appId}/public/data/users`, user.uid), {
                    name: name,
                    email: email,
                    role: role,
                    isClockedIn: false,
                    createdAt: serverTimestamp()
                });

                document.getElementById('add-staff-form').classList.add('hidden');
                document.getElementById('add-staff-form').reset();
            } catch (error) {
                console.error("Error creating user: ", error);
                errorP.textContent = "Error al crear el usuario. " + error.message;
            }
        });

        function listenToStaff() {
            const q = query(collection(db, `artifacts/${appId}/public/data/users`));
            onSnapshot(q, (snapshot) => {
                const staffList = document.getElementById('staff-list');
                staffList.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const user = { id: docSnap.id, ...docSnap.data() };
                    staffList.appendChild(createStaffRow(user));
                });
            });
        }
        
        function createStaffRow(user) {
            const row = document.createElement('div');
            row.className = 'p-3 border rounded-md bg-gray-50 flex justify-between items-center';
            const statusClass = user.isClockedIn ? 'text-green-500' : 'text-red-500';
            const statusText = user.isClockedIn ? 'Activo' : 'Inactivo';
            
            row.innerHTML = `
                <div>
                    <p class="font-semibold">${user.name}</p>
                    <p class="text-sm text-gray-500">${user.email} - <span class="capitalize font-medium">${user.role}</span></p>
                </div>
                <div>
                    <span class="font-bold ${statusClass}">${statusText}</span>
                </div>
            `;
            return row;
        }

        // --- Historial de Fichajes (Admin) ---
        function listenToTimeEntries() {
            const q = query(collection(db, `artifacts/${appId}/public/data/time_entries`));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('time-entries-list');
                list.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const entry = { id: docSnap.id, ...docSnap.data() };
                    list.appendChild(createTimeEntryRow(entry));
                });
            });
        }

        function createTimeEntryRow(entry) {
            const row = document.createElement('tr');
            
            const clockIn = entry.clockInTime ? entry.clockInTime.toDate().toLocaleString('es-ES') : 'N/A';
            const clockOut = entry.clockOutTime ? entry.clockOutTime.toDate().toLocaleString('es-ES') : 'En curso';
            let duration = 'N/A';
            if (entry.clockInTime && entry.clockOutTime) {
                const diffMs = entry.clockOutTime.toDate() - entry.clockInTime.toDate();
                const diffMins = Math.round(diffMs / 60000);
                duration = `${Math.floor(diffMins / 60)}h ${diffMins % 60}m`;
            }

            row.innerHTML = `
                <td class="text-left py-3 px-4">${entry.userName}</td>
                <td class="text-left py-3 px-4">${clockIn}</td>
                <td class="text-left py-3 px-4">${clockOut}</td>
                <td class="text-left py-3 px-4">${duration}</td>
            `;
            return row;
        }
        
        // --- Estadísticas (Admin) ---
        function listenToStats() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            onSnapshot(usersRef, (snapshot) => {
                let active = 0;
                let driversOnRoute = 0;
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.isClockedIn) {
                        active++;
                        if (user.role === 'repartidor') {
                            driversOnRoute++;
                        }
                    }
                });
                document.getElementById('active-employees-stat').textContent = active;
                document.getElementById('drivers-on-route-stat').textContent = driversOnRoute;
            });

            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const q = query(ordersRef, where("status", "!=", "delivered"));
            onSnapshot(q, (snapshot) => {
                document.getElementById('pending-orders-stat').textContent = snapshot.size;
            });
        }

        // --- Pedidos Asignados (Repartidor) ---
        function listenToAssignedOrders() {
            const q = query(collection(db, `artifacts/${appId}/public/data/orders`), where("assignedDriverId", "==", currentUser.uid), where("status", "==", "out_for_delivery"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('assigned-orders-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = `<p class="text-gray-500">No tienes pedidos asignados en este momento.</p>`;
                }
                snapshot.forEach(docSnap => {
                    const order = { id: docSnap.id, ...docSnap.data() };
                    list.appendChild(createAssignedOrderCard(order));
                });
            });
        }

        function createAssignedOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg bg-blue-50';
            card.innerHTML = `
                <p class="font-bold">${order.customerName}</p>
                <p class="text-sm text-gray-700">${order.address}</p>
                <p class="text-sm mt-1"><strong>Pedido:</strong> ${order.items.join(', ')}</p>
                <div class="mt-3">
                    <button data-order-id="${order.id}" class="employee-mark-delivered-btn w-full bg-green-500 text-white px-3 py-2 rounded-md text-sm hover:bg-green-600">Marcar como Entregado</button>
                </div>
            `;
            return card;
        }

        document.getElementById('assigned-orders-list').addEventListener('click', async (e) => {
            if (e.target.classList.contains('employee-mark-delivered-btn')) {
                const orderId = e.target.dataset.orderId;
                const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
                try {
                    await updateDoc(orderRef, { status: 'delivered' });
                    alert('¡Pedido entregado con éxito!');
                } catch (error) {
                    console.error("Error marking order as delivered:", error);
                }
            }
        });

    </script>
</body>
</html>
